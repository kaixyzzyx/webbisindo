{% extends "base.html" %}

{% block title %}Pembelajaran Kosakata - BISINDO{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="text-center mb-4">
            <i class="fas fa-book-open"></i> Pembelajaran Kosakata Dasar BISINDO
        </h2>
        <p class="text-center text-muted mb-4">
            Pelajari kosakata sehari-hari dalam bahasa isyarat Indonesia
        </p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6 mx-auto">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" id="searchInput" placeholder="Cari kosakata...">
        </div>
    </div>
</div>

<div class="row" id="vocabulary-grid">
    <!-- Vocabulary cards will be generated by JavaScript -->
</div>

<!-- Modal for detailed view -->
<div class="modal fade" id="vocabularyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Kosakata</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="modalContent">
                    <!-- Content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                <button type="button" class="btn btn-primary" id="practiceVocabBtn">Latihan Kata Ini</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load vocabulary data from database
const materials = {{ materials|tojson|safe }};
const vocabularyData = [];

if (materials && materials.length > 0) {
    materials.forEach(material => {
        const word = material[2]; // title
        const content = material[3] || ''; // content
        
        // Parse category and difficulty from content if available
        let category = 'greeting';
        let difficulty = 'mudah';
        
        if (content.includes('keluarga')) category = 'family';
        else if (content.includes('aktivitas') || content.includes('harian')) category = 'daily';
        else if (content.includes('emosi') || content.includes('perasaan')) category = 'emotion';
        else if (content.includes('angka') || content.includes('nomor')) category = 'number';
        
        vocabularyData.push({
            word: word,
            category: category,
            meaning: content || 'Kosakata BISINDO',
            difficulty: difficulty
        });
    });
}

// Show message if no vocabulary data from database
if (vocabularyData.length === 0) {
    document.getElementById('vocabulary-grid').innerHTML = `
        <div class="col-12">
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <h5>Belum Ada Data Kosakata</h5>
                <p>Silakan hubungi admin untuk menambahkan data kosakata ke database.</p>
            </div>
        </div>
    `;
}

const vocabularyGrid = document.getElementById('vocabulary-grid');
const categoryFilter = document.getElementById('categoryFilter');
const searchInput = document.getElementById('searchInput');

let learnedStatus = {};

function loadLearningStatus() {
    fetch('/api/user/learning-status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                learnedStatus = data.learned;
                renderVocabulary(vocabularyData);
            }
        })
        .catch(error => console.error('Error loading learning status:', error));
}

function renderVocabulary(data) {
    vocabularyGrid.innerHTML = '';
    
    data.forEach(vocab => {
        const statusKey = `vocabulary_${vocab.word}`;
        const isLearned = learnedStatus[statusKey];
        
        let statusBadge = '<span class="badge bg-light text-primary border border-primary">Belum Dipelajari</span>';
        if (isLearned) {
            const accuracy = Math.round(isLearned);
            if (accuracy >= 80) {
                statusBadge = '<span class="badge bg-success">Dikuasai</span>';
            } else {
                statusBadge = '<span class="badge bg-warning">Perlu Latihan</span>';
            }
        }
        
        const col = document.createElement('div');
        col.className = 'col-md-4 col-sm-6 col-12 mb-3';
        
        col.innerHTML = `
            <div class="card h-100 vocabulary-card border-0 shadow-sm" data-word="${vocab.word}">
                <div class="card-body text-center p-4">
                    <div class="mb-3">
                        <h5 class="card-title text-primary mb-0 fw-bold">${vocab.word}</h5>
                    </div>
                    <div class="vocabulary-image mb-3">
                        ${materials.find(m => m[2] === vocab.word && m[4]) ? 
                            `<img src="${materials.find(m => m[2] === vocab.word)[4]}" alt="${vocab.word}">` :
                            '<i class="fas fa-hands"></i>'
                        }
                    </div>
                    <div class="mb-3">${statusBadge}</div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm rounded-pill" onclick="showVocabulary('${vocab.word}')">
                            <i class="fas fa-eye me-1"></i>Lihat Detail
                        </button>
                        <button class="btn btn-primary btn-sm rounded-pill" onclick="practiceVocab('${vocab.word}')">
                            <i class="fas fa-play me-1"></i>Mulai Latihan
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        vocabularyGrid.appendChild(col);
    });
}

function filterVocabulary() {
    const search = searchInput.value.toLowerCase();
    
    let filtered = vocabularyData;
    
    if (search) {
        filtered = filtered.filter(vocab => 
            vocab.word.toLowerCase().includes(search) || 
            vocab.meaning.toLowerCase().includes(search)
        );
    }
    
    renderVocabulary(filtered);
}

function showVocabulary(word) {
    const vocab = vocabularyData.find(v => v.word === word);
    const modal = new bootstrap.Modal(document.getElementById('vocabularyModal'));
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    const practiceBtn = document.getElementById('practiceVocabBtn');
    
    modalTitle.textContent = vocab.word;
    
    modalContent.innerHTML = `
        <div class="text-center">
            ${materials.find(m => m[2] === vocab.word && m[4]) ? 
                `<img src="${materials.find(m => m[2] === vocab.word)[4]}" alt="${vocab.word}" style="max-width: 100%; max-height: 400px; object-fit: contain; border-radius: 8px;">` :
                '<i class="fas fa-hands fa-5x text-primary"></i>'
            }
        </div>
    `;
    
    practiceBtn.onclick = function() {
        practiceVocab(vocab.word);
    };
    
    modal.show();
}

function getCategoryName(category) {
    const categories = {
        'greeting': 'Salam & Sapaan',
        'family': 'Keluarga',
        'daily': 'Aktivitas Harian',
        'emotion': 'Emosi',
        'number': 'Angka'
    };
    return categories[category] || category;
}

function getDifficultyColor(difficulty) {
    const colors = {
        'mudah': 'success',
        'sedang': 'warning',
        'sulit': 'danger'
    };
    return colors[difficulty] || 'secondary';
}

// Event listeners
searchInput.addEventListener('input', filterVocabulary);

// Initialize
loadLearningStatus();

function practiceVocab(word) {
    window.location.href = `/practice/vocabulary?word=${encodeURIComponent(word)}`;
}

// Add card styles and hover effects
document.addEventListener('DOMContentLoaded', function() {
    const style = document.createElement('style');
    style.textContent = `
        .vocabulary-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 15px !important;
        }
        
        .vocabulary-card:hover {
            box-shadow: 0 8px 25px rgba(0,123,255,0.15) !important;
            transform: translateY(-8px);
        }
        
        .badge {
            font-size: 0.75rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }
        
        .vocabulary-image {
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
        }
        
        .vocabulary-image img {
            width: 100px !important;
            height: 100px !important;
            object-fit: contain !important;
        }
        
        .vocabulary-image i {
            font-size: 3.5rem !important;
            color: #007bff !important;
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}
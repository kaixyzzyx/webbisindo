{% extends "base.html" %}

{% block title %}Pembelajaran Abjad - BISINDO{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="text-center mb-4">
            <i class="fas fa-font"></i> Pembelajaran Abjad A-Z BISINDO
        </h2>
        <p class="text-center text-muted mb-4">
            Pelajari setiap huruf dalam bahasa isyarat Indonesia
        </p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6 mx-auto">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" id="searchInput" placeholder="Cari huruf...">
        </div>
    </div>
</div>

<div class="row" id="alphabet-grid">
    <!-- Alphabet cards will be generated by JavaScript -->
</div>

<!-- Modal for detailed view -->
<div class="modal fade" id="letterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Huruf A</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="modalContent">
                    <!-- Content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                <button type="button" class="btn btn-primary" id="practiceBtn">Latihan Huruf Ini</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const alphabetGrid = document.getElementById('alphabet-grid');
const searchInput = document.getElementById('searchInput');
const materials = {{ materials|tojson|safe }};

let alphabetData = [];

// Generate alphabet data from database
if (materials && materials.length > 0) {
    materials.forEach(material => {
        const letter = material[2]; // title
        alphabetData.push({
            letter: letter,
            content: material[3] || ''
        });
    });
} else {
    // Fallback to A-Z if no data
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    alphabet.forEach(letter => {
        alphabetData.push({
            letter: letter,
            content: ''
        });
    });
}

let learnedStatus = {};

function loadLearningStatus() {
    fetch('/api/user/learning-status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                learnedStatus = data.learned;
                renderAlphabet(alphabetData);
            }
        })
        .catch(error => console.error('Error loading learning status:', error));
}

function renderAlphabet(data) {
    alphabetGrid.innerHTML = '';
    
    data.forEach(item => {
        const statusKey = `alphabet_${item.letter}`;
        const isLearned = learnedStatus[statusKey];
        
        let statusBadge = '<span class="badge bg-light text-primary border border-primary">Belum Dipelajari</span>';
        if (isLearned) {
            const accuracy = Math.round(isLearned);
            if (accuracy >= 80) {
                statusBadge = '<span class="badge bg-success">Dikuasai</span>';
            } else {
                statusBadge = '<span class="badge bg-warning">Perlu Latihan</span>';
            }
        }
        
        const col = document.createElement('div');
        col.className = 'col-md-3 col-sm-4 col-6 mb-3';
        
        col.innerHTML = `
            <div class="card h-100 alphabet-card border-0 shadow-sm" data-letter="${item.letter}">
                <div class="card-body text-center p-4">
                    <div class="mb-3">
                        <h3 class="card-title text-primary mb-0 fw-bold">${item.letter}</h3>
                    </div>
                    <div class="alphabet-image mb-3">
                        ${materials.find(m => m[2] === item.letter && m[4]) ? 
                            `<img src="${materials.find(m => m[2] === item.letter)[4]}" alt="${item.letter}">` :
                            '<i class="fas fa-hand-paper"></i>'
                        }
                    </div>
                    <div class="mb-3">${statusBadge}</div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm rounded-pill" onclick="showLetter('${item.letter}', '${item.content}')">
                            <i class="fas fa-eye me-1"></i>Lihat Detail
                        </button>
                        <button class="btn btn-primary btn-sm rounded-pill" onclick="practiceLetter('${item.letter}')">
                            <i class="fas fa-play me-1"></i>Mulai Latihan
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        alphabetGrid.appendChild(col);
    });
}

function filterAlphabet() {
    const search = searchInput.value.toLowerCase();
    
    let filtered = alphabetData;
    
    if (search) {
        filtered = filtered.filter(item => 
            item.letter.toLowerCase().includes(search)
        );
    }
    
    renderAlphabet(filtered);
}

function practiceLetter(letter) {
    window.location.href = `/practice/alphabet?letter=${letter}`;
}

function showLetter(letter, content = '') {
    const modal = new bootstrap.Modal(document.getElementById('letterModal'));
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    const practiceBtn = document.getElementById('practiceBtn');
    
    modalTitle.textContent = `Huruf ${letter}`;
    
    modalContent.innerHTML = `
        <div class="text-center">
            ${materials.find(m => m[2] === letter && m[4]) ? 
                `<img src="${materials.find(m => m[2] === letter)[4]}" alt="${letter}" style="max-width: 100%; max-height: 400px; object-fit: contain; border-radius: 8px;">` :
                '<i class="fas fa-hand-paper fa-5x text-primary"></i>'
            }
        </div>
    `;
    
    practiceBtn.onclick = function() {
        practiceLetter(letter);
    };
    
    modal.show();
}

// Event listeners
searchInput.addEventListener('input', filterAlphabet);

// Initialize
loadLearningStatus();

// Add card styles and hover effects
document.addEventListener('DOMContentLoaded', function() {
    const style = document.createElement('style');
    style.textContent = `
        .alphabet-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 15px !important;
        }
        
        .alphabet-card:hover {
            box-shadow: 0 8px 25px rgba(0,123,255,0.15) !important;
            transform: translateY(-8px);
        }
        
        .badge {
            font-size: 0.75rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }
        
        .alphabet-image {
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
        }
        
        .alphabet-image img {
            width: 100px !important;
            height: 100px !important;
            object-fit: contain !important;
        }
        
        .alphabet-image i {
            font-size: 3.5rem !important;
            color: #007bff !important;
        }
    `;
    document.head.appendChild(style);
});
</script>


{% endblock %}
{% extends "admin_base.html" %}

{% block title %}Materi Abjad - Admin BISINDO{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Manajemen Materi Abjad</h2>
        <button class="btn btn-primary" onclick="addMaterial()">
            <i class="fas fa-plus me-1"></i> Tambah Materi
        </button>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Huruf</th>
                            <th>Judul</th>
                            <th>Konten</th>
                            <th>Gambar</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="materials-table">
                        <tr>
                            <td colspan="6" class="text-center">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
fetch('/api/admin/materials?type=alphabet')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const tbody = document.getElementById('materials-table');
            tbody.innerHTML = '';
            data.materials.forEach(material => {
                tbody.innerHTML += `
                    <tr>
                        <td><span class="badge bg-primary">${material.title.charAt(0)}</span></td>
                        <td>${material.title}</td>
                        <td>${material.content ? material.content.substring(0, 50) + '...' : 'No content'}</td>
                        <td>
                            ${material.image_path ? 
                                `<img src="${material.image_path}" alt="${material.title}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 8px;">` : 
                                '<i class="fas fa-times text-danger"></i>'
                            }
                        </td>
                        <td><span class="badge bg-success">Active</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editMaterial(${material.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteMaterial(${material.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }
    });

function editMaterial(id) {
    fetch(`/api/admin/materials/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const material = data.material;
                showEditModal('Edit Materi Abjad', [
                    {label: 'Judul', name: 'title', value: material.title},
                    {label: 'Konten', name: 'content', value: material.content, type: 'textarea'},
                    {label: 'Gambar', name: 'image', type: 'file', currentImage: material.image_path}
                ], (formData) => {
                    fetch(`/api/admin/materials/${id}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            type: material.type,
                            title: formData.title,
                            content: formData.content,
                            image_path: formData.image_path || material.image_path,
                            video_path: material.video_path
                        })
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            location.reload();
                        } else {
                            alert('Error updating material');
                        }
                    });
                });
            }
        });
}

function deleteMaterial(id) {
    if (confirm('Yakin ingin menghapus materi ini?')) {
        fetch(`/api/admin/materials/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting material');
            }
        });
    }
}

function showEditModal(title, fields, onSave) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.style.backgroundColor = 'rgba(0,0,0,0.4)';
    modal.innerHTML = `
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border: none; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
                <div class="modal-header" style="border: none; padding: 2rem 2rem 1rem;">
                    <h5 class="modal-title fw-bold" style="color: #2c3e50;">${title}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" style="background: none; border: none; font-size: 1.5rem; opacity: 0.6;"></button>
                </div>
                <div class="modal-body" style="padding: 1rem 2rem;">
                    <form id="editForm">
                        ${fields.map(field => `
                            <div class="mb-4">
                                <label class="form-label fw-semibold" style="color: #34495e; margin-bottom: 0.8rem;">${field.label}</label>
                                ${field.type === 'textarea' ? 
                                    `<textarea class="form-control" name="${field.name}" rows="3" style="border: 2px solid #e8f4fd; border-radius: 15px; padding: 1rem; background: rgba(255,255,255,0.8); transition: all 0.3s ease;" onfocus="this.style.borderColor='#3498db'; this.style.boxShadow='0 0 0 3px rgba(52,152,219,0.1)'" onblur="this.style.borderColor='#e8f4fd'; this.style.boxShadow='none'">${field.value || ''}</textarea>` :
                                field.type === 'file' ?
                                    `<div>
                                        ${field.currentImage ? `<div class="mb-2"><img src="${field.currentImage}" alt="Current" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;"><br><small class="text-muted">Gambar saat ini</small></div>` : ''}
                                        <input type="file" class="form-control" name="${field.name}" accept="image/*" style="border: 2px solid #e8f4fd; border-radius: 15px; padding: 1rem; background: rgba(255,255,255,0.8);" onchange="previewImage(this, '${field.name}')">
                                        <div id="preview-${field.name}" class="mt-2"></div>
                                    </div>` :
                                    `<input type="text" class="form-control" name="${field.name}" value="${field.value || ''}" style="border: 2px solid #e8f4fd; border-radius: 15px; padding: 1rem; background: rgba(255,255,255,0.8); transition: all 0.3s ease;" onfocus="this.style.borderColor='#3498db'; this.style.boxShadow='0 0 0 3px rgba(52,152,219,0.1)'" onblur="this.style.borderColor='#e8f4fd'; this.style.boxShadow='none'">`
                                }
                            </div>
                        `).join('')}
                    </form>
                </div>
                <div class="modal-footer" style="border: none; padding: 1rem 2rem 2rem; justify-content: center; gap: 1rem;">
                    <button type="button" class="btn" data-bs-dismiss="modal" style="background: rgba(108,117,125,0.1); color: #6c757d; border: none; border-radius: 25px; padding: 0.8rem 2rem; font-weight: 500; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(108,117,125,0.2)'" onmouseout="this.style.background='rgba(108,117,125,0.1)'">Batal</button>
                    <button type="button" class="btn" onclick="saveEdit()" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; border-radius: 25px; padding: 0.8rem 2rem; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(52,152,219,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(52,152,219,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(52,152,219,0.3)'">Simpan</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    window.saveEdit = function() {
        const form = document.getElementById('editForm');
        const formData = new FormData(form);
        const data = {};
        
        // Handle file upload first if there's an image
        const imageFile = formData.get('image');
        if (imageFile && imageFile.size > 0) {
            const uploadFormData = new FormData();
            uploadFormData.append('image', imageFile);
            
            fetch('/upload_image', {
                method: 'POST',
                body: uploadFormData
            })
            .then(response => response.json())
            .then(uploadResult => {
                if (uploadResult.success) {
                    // Add image path to data
                    for (let [key, value] of formData.entries()) {
                        if (key !== 'image') data[key] = value;
                    }
                    data.image_path = uploadResult.image_path;
                    onSave(data);
                } else {
                    alert('Error uploading image: ' + uploadResult.error);
                }
            });
        } else {
            // No image upload, proceed normally
            for (let [key, value] of formData.entries()) {
                if (key !== 'image') data[key] = value;
            }
            onSave(data);
        }
        
        bsModal.hide();
        modal.remove();
    };
    
    window.previewImage = function(input, fieldName) {
        const preview = document.getElementById(`preview-${fieldName}`);
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; margin-top: 10px;"><br><small class="text-muted">Preview gambar baru</small>`;
            };
            reader.readAsDataURL(input.files[0]);
        }
    };
    
    modal.addEventListener('hidden.bs.modal', () => {
        modal.remove();
    });
}

function addMaterial() {
    showEditModal('Tambah Materi Abjad', [
        {label: 'Huruf', name: 'title', value: ''},
        {label: 'Konten', name: 'content', value: '', type: 'textarea'},
        {label: 'Gambar', name: 'image', type: 'file'}
    ], (formData) => {
        fetch('/api/admin/materials', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                type: 'alphabet',
                title: formData.title,
                content: formData.content,
                image_path: formData.image_path || '',
                video_path: ''
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                location.reload();
            } else {
                alert('Error adding material');
            }
        });
    });
}
</script>
{% endblock %}